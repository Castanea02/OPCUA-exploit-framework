# 특정 Node ID에 대한 정보를 얻는 Sanity 테스트 스크립트
# 주어진 서버 세부 정보를 사용하여 지정된 Node ID에 대한 정보를 OPC UA 클라이언트로부터 조회

from asyncua import Client
import asyncio

# 공격 함수 (비동기 함수로 구현)
def attack(server_details):
    asyncio.run(attack_impl(server_details))

# 공격 실행 함수
async def attack_impl(server_details, name_space=0, node_id=3875):
    program_type, ip_addr, port, query_string = server_details

    opcua_uri = f"opc.tcp://{ip_addr}:{port}{query_string}"
    opcua_client = Client(opcua_uri)

    # OPC UA 클라이언트 세션 시작
    async with opcua_client:
        # 루트 오브젝트의 하위 항목들을 가져옴
        children = await opcua_client.nodes.objects.get_children()
        print(f"[-] Children: {children}")

        # 지정된 네임스페이스 및 Node ID를 가진 노드의 이름 읽기
        node = opcua_client.get_node(f"ns={name_space};i={node_id}")
        node_name = await node.read_display_name()
        print(f"[-] Namespace: {name_space}, NodeID: {node_id}: {node_name.Text}")
